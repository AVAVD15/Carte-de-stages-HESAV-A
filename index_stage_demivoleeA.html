<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte interactive des stages – demi-volée A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #filters {
      padding: 8px 12px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
    }

    #filters span.label {
      font-weight: 600;
      margin-right: 6px;
    }

    #filters label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background-color 0.15s ease;
    }

    #filters label:hover {
      background-color: #e8e8e8;
    }

    #map {
      flex: 1;
      width: 100%;
    }

    .popup-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .popup-address {
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .popup-points {
      margin-top: 4px;
      font-size: 0.85rem;
    }

    .popup-points ul {
      padding-left: 18px;
    }

    .popup-points li {
      margin: 1px 0;
    }
  </style>
</head>
<body>
  <div id="filters">
    <span class="label">Filtres domaines&nbsp;:</span>
    <label><input type="checkbox" data-filter="msq" /> MSQ</label>
    <label><input type="checkbox" data-filter="neuro" /> Neuro</label>
    <label><input type="checkbox" data-filter="cardio" /> Cardio-resp</label>
    <label><input type="checkbox" data-filter="geriatrie" /> Gériatrie</label>
    <label><input type="checkbox" data-filter="autre" /> Autre spé.</label>
    <label><input type="checkbox" data-filter="aigu" /> Aigu</label>
    <label><input type="checkbox" data-filter="readapt" /> Réadaptation</label>
    <label><input type="checkbox" data-filter="ambulatoire" /> Ambulatoire</label>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // =========================
    // Données des 42 lieux de stage – demi-volée A
    // =========================
    // NOTE: quelques coordonnées (lat/lng) sont approximatives pour les lieux
    // où elles n’étaient pas indiquées dans ton tableau. Tu pourras les affiner
    // si besoin directement ici.

    const stages = [
      {
        id: 1,
        name: "Aquamed Centres de physiothérapie – Aubonne",
        address: "Chemin de Clamogne 4, 1170 Aubonne (VD)",
        lat: 46.4880071,
        lng: 6.3982959,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 2,
        name: "Cabinet Audrey Schneiter – Physiothérapie à domicile",
        address: "Rue de la Croix-de-Montet 2, 1616 Attalens (FR)",
        lat: 46.513195,
        lng: 6.8473949,
        msq: 1,
        neuro: 0.5,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 3,
        name: "Cuennet JMC Sàrl",
        address: "Route du Château 8, 1723 Marly (FR)",
        lat: 46.77619,
        lng: 7.16928,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 4,
        name: "La Colline – Romont",
        address: "Route de Billens 8, 1680 Romont (FR)",
        lat: 46.6922285,
        lng: 6.912644,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 5,
        name: "Centre ITS – Marly",
        address: "Route du Midi 12, 1723 Marly (FR)",
        lat: 46.7810554,
        lng: 7.1503663,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 6,
        name: "Clinique Bois-Bougy Nyon",
        address: "Avenue de Bois-Bougy 6, 1260 Nyon (VD)",
        lat: 46.3726182,
        lng: 6.2290099,
        msq: 1,
        neuro: 0.5,
        cardio: 0.5,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 7,
        name: "Clinique Bois-Cerf Lausanne",
        address: "Avenue d’Ouchy 31, 1006 Lausanne (VD)",
        lat: 46.5133,
        lng: 6.6292,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0.5,
      },
      {
        id: 8,
        name: "CRR SUVA – Neurologie",
        address: "Avenue Grand-Champsec 90, 1950 Sion (VS)",
        lat: 46.2339577,
        lng: 7.3836195,
        msq: 0,
        neuro: 1,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 9,
        name: "CRR SUVA – Physiothérapie",
        address: "Avenue Grand-Champsec 90, 1950 Sion (VS)",
        lat: 46.2339577,
        lng: 7.3836195,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 10,
        name: "CHUV Ortho DAL",
        address: "Avenue Pierre-Decker 4, 1011 Lausanne (VD)",
        lat: 46.5234,
        lng: 6.63,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0.5,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 11,
        name: "CHUV BH14 Traumatologie",
        address: "Avenue Pierre-Decker 4, 1011 Lausanne (VD)",
        lat: 46.5234,
        lng: 6.63,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0.5,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 12,
        name: "CHUV – Physiothérapie CUTR Sylvana",
        address: "Chemin de Sylvana 10, 1066 Epalinges (VD)",
        lat: 46.551,
        lng: 6.663,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 13,
        name: "CHUV – Médecine interne DMEG",
        address: "Rue du Bugnon 46, 1011 Lausanne (VD)",
        lat: 46.523,
        lng: 6.635,
        msq: 0,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 14,
        name: "CHUV – Neurochirurgie BH13",
        address: "Rue du Bugnon 46, 1011 Lausanne (VD)",
        lat: 46.523,
        lng: 6.635,
        msq: 0,
        neuro: 1,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 15,
        name: "CHUV – Neurohabilitation Nestlé",
        address: "Avenue du Bugnon 21, 1011 Lausanne (VD)",
        lat: 46.5226,
        lng: 6.6354,
        msq: 0,
        neuro: 1,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 16,
        name: "EHC – GOZ Sport",
        address: "Rue Dr-Yersin 12a, 1110 Morges (VD)",
        lat: 46.5139,
        lng: 6.4929,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 17,
        name: "Hôpital de Morges",
        address: "Chemin du Crêt 2, 1110 Morges (VD)",
        lat: 46.50954,
        lng: 6.49525,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0.5,
      },
      {
        id: 18,
        name: "Hôpital d’Orbe – ENHO",
        address: "Rue de l’Hôpital 15, 1350 Orbe (VD)",
        lat: 46.7227,
        lng: 6.5432,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 19,
        name: "Hôpital d’Yverdon – ENHV",
        address: "Rue d’Entremonts 11, 1400 Yverdon-les-Bains (VD)",
        lat: 46.7785,
        lng: 6.6419,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 20,
        name: "Hôpital de Saint-Loup",
        address: "Saint-Loup 1, 1318 Pompaples (VD)",
        lat: 46.6768,
        lng: 6.6029,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 0.5,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 21,
        name: "GHOL – Hôpital de Nyon",
        address: "Chemin Monastier 10, 1260 Nyon (VD)",
        lat: 46.3865,
        lng: 6.2304,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 0.5,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 22,
        name: "GHOL – Rolle",
        address: "Rue du Temple 26, 1180 Rolle (VD)",
        lat: 46.4629,
        lng: 6.3434,
        msq: 0,
        neuro: 0,
        cardio: 1,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 23,
        name: "HFR Fribourg",
        address: "Pensionnats 2/6, 1752 Villars-sur-Glâne (FR)",
        lat: 46.79235,
        lng: 7.13369,
        msq: 0,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 24,
        name: "HFR Riaz",
        address: "Route de l’Hôpital 26, 1632 Riaz (FR)",
        lat: 46.6417274,
        lng: 7.0585063,
        msq: 0,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 25,
        name: "HIB Estavayer",
        address: "Rue de la Chapelle 3, 1470 Estavayer-le-Lac (FR)",
        lat: 46.8483124,
        lng: 6.8516869,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 26,
        name: "HIB Payerne",
        address: "Route de la Colline 3, 1530 Payerne (VD)",
        lat: 46.82047,
        lng: 6.9384,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 27,
        name: "Hôpital de Lavaux",
        address: "Chemin de la Prairie 3, 1096 Cully (VD)",
        lat: 46.4881,
        lng: 6.7271,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 28,
        name: "Providence Vevey",
        address: "Route de Vevey 16, 1800 Vevey (VD)",
        lat: 46.4656,  /* approx. centre de Vevey */
        lng: 6.8489,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 29,
        name: "HRC Rennaz",
        address: "Vieux Séquoia 30, 1847 Rennaz (VD)",
        lat: 46.3832,
        lng: 6.9257,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 1,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 30,
        name: "Institution de Lavigny",
        address: "Route du Vignoble 60, 1175 Lavigny (VD)",
        lat: 46.50789,
        lng: 6.3895,
        msq: 0,
        neuro: 1,
        cardio: 0,
        geriatrie: 0.5,
        autre: 0,
        aigu: 0,
        readapt: 1,
        ambulatoire: 0,
      },
      {
        id: 31,
        name: "La Source – Clinique",
        address: "Avenue des Bergières 14, 1004 Lausanne (VD)",
        lat: 46.5245, /* approx. Lausanne nord-ouest */
        lng: 6.624,
        msq: 0,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 0,
      },
      {
        id: 32,
        name: "La Source VidyMed",
        address: "Route de Chavannes 33, 1007 Lausanne (VD)",
        lat: 46.52, /* approx Vidy/Chavannes */
        lng: 6.604,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 33,
        name: "Lavey Medical SA",
        address: "Route des Bains 48, 1892 Lavey-les-Bains (VD)",
        lat: 46.214, /* approx Bains de Lavey */
        lng: 7.021,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 34,
        name: "Physio 7",
        address: "Rue de la Morâche 5C, 1260 Nyon (VD)",
        lat: 46.3825,
        lng: 6.231,
        msq: 1,
        neuro: 0.5,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 35,
        name: "Motion Lab",
        address: "Chemin de Budron A7, 1052 Le Mont-sur-Lausanne (VD)",
        lat: 46.54401,
        lng: 6.62613,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 36,
        name: "Physio Clinics – Aigle",
        address: "Route de Lausanne 64, 1860 Aigle (VD)",
        lat: 46.317,
        lng: 6.968,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 37,
        name: "Physio Clinics – Clarens",
        address: "Rue du Lac 19A, 1815 Clarens (VD)",
        lat: 46.4405,
        lng: 6.8995,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 38,
        name: "Physio Clinics – Lausanne",
        address: "Boulevard de Grancy 19, 1006 Lausanne (VD)",
        lat: 46.5169,
        lng: 6.6337,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 39,
        name: "PSPE – Pôle Santé Pays d’Enhaut",
        address: "Chemin du Perrey 1, 1660 Château-d’Oex (VD)",
        lat: 46.483,
        lng: 7.129,
        msq: 0.5,
        neuro: 0.5,
        cardio: 0.5,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 0.5,
        ambulatoire: 0.5,
      },
      {
        id: 40,
        name: "Pôle Santé Vallée de Joux",
        address: "Rue du Village 13, 1347 Le Sentier (VD)",
        lat: 46.6065,
        lng: 6.234,
        msq: 1,
        neuro: 0,
        cardio: 0.5,
        geriatrie: 1,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 41,
        name: "ProMove Santé",
        address: "Chemin de la Charrettaz 6, 1094 Paudex (VD)",
        lat: 46.5088,
        lng: 6.6765,
        msq: 1,
        neuro: 0,
        cardio: 0,
        geriatrie: 0.5,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 1,
      },
      {
        id: 42,
        name: "Réseau Santé Balcon du Jura",
        address: "Rue des Rosiers 29, 1450 Sainte-Croix (VD)",
        lat: 46.824,
        lng: 6.503,
        msq: 0,
        neuro: 0,
        cardio: 0,
        geriatrie: 0,
        autre: 0,
        aigu: 0,
        readapt: 0,
        ambulatoire: 0,
      },
    ];

    // =========================
    // Initialisation de la carte Leaflet
    // =========================
    const map = L.map("map");

    const osmLayer = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      }
    );

    osmLayer.addTo(map);

    // MarkerCluster
    const markerCluster = L.markerClusterGroup();
    const stageMarkers = []; // { stage, marker }

    function buildPopupContent(stage) {
      let html = `<div class="popup-content">`;
      html += `<div class="popup-title">${stage.name}</div>`;
      html += `<div class="popup-address">${stage.address}</div>`;

      const items = [];
      if (stage.msq > 0) items.push(`MSQ&nbsp;: ${stage.msq}`);
      if (stage.neuro > 0) items.push(`Neuro&nbsp;: ${stage.neuro}`);
      if (stage.cardio > 0) items.push(`Cardio-resp&nbsp;: ${stage.cardio}`);
      if (stage.geriatrie > 0) items.push(`Gériatrie&nbsp;: ${stage.geriatrie}`);
      if (stage.autre > 0) items.push(`Autre spé.&nbsp;: ${stage.autre}`);
      if (stage.aigu > 0) items.push(`Aigu&nbsp;: ${stage.aigu}`);
      if (stage.readapt > 0) items.push(`Réadaptation&nbsp;: ${stage.readapt}`);
      if (stage.ambulatoire > 0)
        items.push(`Ambulatoire&nbsp;: ${stage.ambulatoire}`);

      if (items.length > 0) {
        html += `<div class="popup-points"><strong>Points par domaine :</strong><ul>`;
        for (const it of items) {
          html += `<li>${it}</li>`;
        }
        html += `</ul></div>`;
      } else {
        html += `<div class="popup-points"><em>Aucun point de domaine renseigné.</em></div>`;
      }

      html += `</div>`;
      return html;
    }

    // Création des marqueurs
    stages.forEach((stage) => {
      const marker = L.marker([stage.lat, stage.lng]);
      marker.bindPopup(buildPopupContent(stage));
      stageMarkers.push({ stage, marker });
      markerCluster.addLayer(marker);
    });

    map.addLayer(markerCluster);

    if (stageMarkers.length > 0) {
      const bounds = markerCluster.getBounds();
      if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      } else {
        map.setView([46.7, 6.6], 9);
      }
    } else {
      map.setView([46.7, 6.6], 9);
    }

    // =========================
    // Gestion des filtres
    // =========================
    const filterCheckboxes = document.querySelectorAll(
      "#filters input[type=checkbox]"
    );

    function applyFilters() {
      const activeFilters = Array.from(filterCheckboxes)
        .filter((cb) => cb.checked)
        .map((cb) => cb.dataset.filter);

      markerCluster.clearLayers();

      stageMarkers.forEach(({ stage, marker }) => {
        let keep = true;
        if (activeFilters.length > 0) {
          // AND logique: le stage doit avoir >0 pour tous les filtres cochés
          keep = activeFilters.every((key) => stage[key] && stage[key] > 0);
        }

        if (keep) {
          markerCluster.addLayer(marker);
        }
      });
    }

    filterCheckboxes.forEach((cb) => {
      cb.addEventListener("change", applyFilters);
    });

    // Au chargement : aucun filtre => tous les points visibles immédiatement
    applyFilters();
  </script>
</body>
</html>
